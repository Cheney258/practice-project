<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¾Šäº†ä¸ªå…»</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
    }

    .main {
      position: relative;
    }

    .item {
      position: absolute;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: left .3s, top .3s, transform .3s;
    }

    .item::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      transition: background-color .2s;
    }

    .item.disabled:after {
      background-color: rgba(0, 0, 0, .7);
    }

    .move-list {
      border: 1px solid #ddd;
      background-color: #ddd;
      margin: 0 auto;
    }
  </style>
</head>

<body>
  <!-- å¡ç‰Œå®¹å™¨ -->
  <div class="main"></div>
  <!-- æ¶ˆé™¤å¡ç‰Œçš„å®¹å™¨ -->
  <div class="move-list"></div>


  <script>
    // åŸºç¡€æ•°æ®
    const simpleData = [{
        name: 'ðŸ…',
        color: '#ff1100'
      },
      {
        name: 'ðŸ‡',
        color: '#ff8800'
      },
      {
        name: 'ðŸ‚',
        color: 'green'
      },
      {
        name: 'ðŸ',
        color: '#779922'
      },
      {
        name: 'ðŸ',
        color: 'blue'
      },
      {
        name: 'ðŸ€',
        color: '#335577'
      },
    ]

    // ç¬¬ä¸€æ­¥ ç»˜å›¾
    // å¡ç‰‡å¤§å°
    const size = 30
    const rows = 10 // è¡Œæ•°
    const cols = 10 // åˆ—æ•°
    const oneGroupCount = 3 // 3ä¸ªä¸€ç»„å°æ¶ˆé™¤
    const group = 6 //  æ¯ä¸ªæ¶ˆé™¤å‹6æ›¾
    const layersCount = 6 //å±‚æ•°6å±‚
    const cellHtml = [] //
    const renderData = Array.from(new Array(oneGroupCount * group)).map(v => {
      return simpleData.map(v => ({
        ...v
      }))
    }).flat().sort(v => Math.random() - 0.5)

    for (let ly = layersCount - 1; ly >= 1; ly--) {
      for (let i = 0; i < rows; i++) {
        for (let j = 0; j < cols; j++) {
          let pyStep = (ly + 1) % 2 === 0 ? size / 2 : 0
          let item = (Math.random() > 0.7 && renderData.pop())
          if (item) {
            cellHtml.push(
              `<div class="item" id="m${ly}-${i}-${j}" onclick="move(this)" style="width:${size}px;height:${size}px;left:${size * j + pyStep}px;top:${size * i + pyStep}px;background-color:${item.color};">${item.name}</div>`
              )
          }
        }
      }
    }

    const main = document.querySelector(".main")
    const moveList = document.querySelector('.move-list')
    main.innerHTML = cellHtml.reverse().join('')
    main.style.height = `${size * rows  + size * 2}px`
    main.style.width = `${size * cols + size * 2}px`
    moveList.style.height = `${size}px`
    moveList.style.width = `${size * 6}px`


    // ç¬¬äºŒæ­¥ï¼šè®¡ç®—å‡ºè¢«æŒ¡ä½çš„åº•ç‰Œï¼Œå¹¶æ ‡æ³¨é¢œè‰²
    const checkDisables = () => {
      main.querySelectorAll('.item').forEach((v, i) => {
        const arr = v.id.substring(1).split('-').map(v => Number(v))
        const isPy = (arr[0] + 1) % 2 === 0
        for (let i = arr[0] + 1; i <= layersCount - 1; i++) {
          const isPyB = (i + 1) % 2 === 0
          if (isPy === isPyB) {
            const el = main.querySelector(`#m${i}-${arr[1]}-${arr[2]}`)
            if (el) {
              v.classList.add('disabled')
              break
            }
          } else if (isPy && !isPyB) {
            const result = [
              `${i}-${arr[1]}-${arr[2]}`,
              `${i}-${arr[1]}-${arr[2]+1}`,
              `${i}-${arr[1]+1}-${arr[2]}`,
              `${i}-${arr[1]+1}-${arr[2]+1}`
            ].every(k => {
              return !main.querySelector('#m' + k)
            })
            if (!result) {
              v.classList.add('disabled')
              break;
            } else {
              v.classList.remove('disabled')
            }
          } else if (!isPy && isPyB) {
            const result = [
              `${i}-${arr[1]}-${arr[2]}`,
              `${i}-${arr[1]}-${arr[2]-1}`,
              `${i}-${arr[1]-1}-${arr[2]}`,
              `${i}-${arr[1]-1}-${arr[2]-1}`
            ].every(k => {
              return !main.querySelector('#m' + k)
            })
            if (!result) {
              v.classList.add('disabled')
              break;
            } else {
              v.classList.remove('disabled')
            }
          }
        }
      })
    }

    // ç¬¬ä¸‰æ­¥ï¼šç‚¹å‡»å¡ç‰‡è¿›è¡Œæ¶ˆé™¤è®¡ç®—
    let canMove = true
    const move = (me) => {
      let left = moveList.offsetLeft
      let top = moveList.offsetTop
      if (!canMove || me.className.indexOf('disabled') >= 0) return
      canMove = false
      if (moveList.children.length > 0) {
        let el = moveList.lastElementChild
        left = el.offsetLeft + size
      }
      me.style.top = `${top}px`
      me.style.left = `${left}px`
      me.transitionNamesCount = 0
      me.ontransitionend = (e) => {
        me.transitionNamesCount++
        if (me.transitionNamesCount === 2) {
          moveEnd(me)
          canMove = true
        }
      }
    }
    // åŠ¨ç”»ç»“æŸåŽçš„è®¡ç®—
    const moveEnd = (me) => {
      me.ontransitionend = null
      me.setAttribute('onclick', '')
      moveList.appendChild(me)
      // æ¶ˆé™¤
      const findResult = [...moveList.children].filter(v => v.innerHTML === me.innerHTML)
      if (findResult.length === 3) {
        findResult.forEach(v => {
          v.ontransitionend = () => {
            moveList.removeChild(v)
            // æ¶ˆé™¤ä¸€ç»„åŽï¼Œå‰©ä½™çš„å‘å‰å½’ä½
            ;
            [...moveList.children].forEach((v, i) => {
              v.style.left = `${i*size + moveList.offsetLeft}px`
            })
            if (moveList.children.length === 6) {
              alert('æ¸¸æˆç»“æŸï¼ï¼ï¼')
              return location.reload()
            } else if (main.children.length === 0) {
              return alert('æ­å–œé€šå…³ï¼ï¼ï¼')
            }
          }
          setTimeout(() => v.style.transform = 'scale(0)')
        })
      }

      checkDisables()
    }

    checkDisables()
  </script>
</body>

</html>